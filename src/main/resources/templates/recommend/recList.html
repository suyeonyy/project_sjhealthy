<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>추천 게시판</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=***REMOVED***&autoload=false"></script> 

</head>
<body>
<h1>추천 게시판</h1>

    <table border="1">
        <thead>
        <tr>
            <th>글 번호</th>
            <th>가게 이름</th>
            <th>추천 메뉴</th>
            <th>작성자</th>
            <th>작성일</th>
            <th>조회수</th>
            <th>좋아요</th>
            <th>싫어요</th>
        </tr>
        </thead>

        <tbody>
        <a id="detail">
            <tr th:each="board : ${list}">
                <!-- <td th:text="${board.recId}" th:value="${board.recId}" id="recId"></td> -->
                 <!-- td에는 value가 없다. 그래서 js에서 읽지 못하고 서버로 보내 null로 보내지는 오류가 있었다.
                  td는 value가 아니라 textContent 나 innerText로 읽어야 한다. 
                  아니면 input 태그를 넣어 value로 읽는다-->
                <td><input type="text" th:value="${board.recId}" class="recId" readonly></td>
                <td th:text="${board.recStore}"></td>
                <td th:text="${board.recMenu}"></td>
                <td th:text="${board.memberId}"></td>
                <td th:text="${board.createDate}"></td>
                <td th:text="${board.recViews}"></td>
                <td><input type="button" class="recY"><span id="like"></span></td>
                <td><input type="button" class="recN"><span id="dislike"></span></td>
            <!-- 바 형태로 표현했으면 좋겠다. -->
             <!-- 선택한 글만 열려서 좋아요싫어요 개수 보이게 만들기(그때 개수 서버에서 구해서 전달) -->
            </tr>
        </a>
        </tbody>
    </table>
    <input type="hidden" th:value="${loginId}" id="loginId"> 
    <!-- th:text는 html 요소의 텍스트 내용을 설정. 따라서 value로 읽으려면 th:value로 해야 한다 -->
    <a href="/sjhealthy"><button>메인</button></a>
    <a href="/sjhealthy/recommend/write" id="writeButton"><button>추천글 작성</button></a>


    <div id="map"></div>

<script>
    document.addEventListener("DOMContentLoaded", ()=>{
        const writeButton = document.getElementById("writeButton");
        const loginId = document.getElementById("loginId").value;
        console.log('loginId = ' + loginId);

        if (writeButton){
            writeButton.addEventListener("click", async (e)=> {

                if (!loginId){ 
                    // 값이 없을 때는 null 이 아니라 "" 빈 문자열이 보내진다. 
                    // 따라서 서버에서 보낸 값을 text로 설정하고 value를 읽어와도 해당 속성 값이 없으니 null이 아니라 ""를 읽어오게 됨
                    // 서버에서 null을 보내도 렌더링 되는 과정에서 ""가 되기 때문에 
                    // 자바스크립트 조건문에서 null과 비교하는 건 의미가 없다.
                    // !로 하면 null일 때랑 빈 문자열일 때 둘 다 false로 판단하니까 이렇게 하면 됨
                    e.preventDefault(); // defaultPrevented는 이벤트가 취소됐는지 확인하는 메서드로 다른 거다. 잘못 쓰지 않도록 하자
                    alert('글은 회원만 작성할 수 있습니다.');
                    return false;
                }
            });
        }

        // const recY = document.getElementById("recY").value;
        // 버튼이 1개가 아니라 글마다 존재하니까 querySelectorAll()을 이용해야 한다.
        const recY = document.querySelectorAll(".recY");
        const recN = document.querySelectorAll(".recN");
        const recIds = document.querySelectorAll(".recId");

        recY.forEach((Y, index) => { // index는 Y가 recY에서 몇 번째 요소인지를 나타내는 인덱스
            Y.addEventListener("click", async (e)=> {
                e.preventDefault();
                // 쿼리셀렉터로는 value를 가져올 수 있으나 All일 때는 이렇게 해서 가져와야 한다.
                const recId = recIds[index].value; // 각 value를 가져옴
                console.log("recId = " + recId);
    
                // id당 1번 버튼 누르기 가능(좋아요/싫어요 중 택1)
                if (!loginId){
                    e.preventDefault();
                    alert('회원 전용 기능입니다.');
                    return false;
                }
    
                try {
                    const response = await fetch("/sjhealthy/recommend/like", {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recId: recId,
                            action: "like"
                            // memberId: loginId 세션에서 꺼내 씀
                        })
                    });
                    const data = await response.json();
                    alert(data.message);
    
                    // 좋아요 싫어요 개수 출력
                    const like = document.getElementById("like");
                    like.textContent = data.likeCount;
                    dislike.textContent = data.dislikeCount;
                } catch (error){
                    console.log('오류 발생: ', error);
                }
            });

        });

        recN.forEach((N, index) => {
            N.addEventListener("click", async (e)=> {
                    e.preventDefault();

                    const recId = recIds[index].value;
    
                    // id당 1번 버튼 누르기 가능(좋아요/싫어요 중 택1)
                    if (!loginId){
                        e.preventDefault();
                        alert('회원 전용 기능입니다.');
                        return false;
                    }
    
                    try {
                    const response = await fetch("/sjhealthy/recommend/dislike", {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recId: recId,
                            action: "dislike"
                            // memberId: loginId 세션에서 꺼내 씀
                        })
                    });
                    const data = await response.json();
                    alert(data.message);
    
                    // 좋아요 싫어요 개수 출력
                    const like = document.getElementById("like");
                    like.textContent = data.likeCount;
                    dislike.textContent = data.dislikeCount;
                } catch (error){
                    console.log('오류 발생: ', error);
                }
    
                });
        });

    });
</script>

<script>


    // document.addEventListener("DOMContentLoaded", ()=>{
    //     const button = document.getElementById("button");
    //     const search = document.getElementById("search").value;

    //     button.addEventListener("click", async (e) => {
    //         e.preventDefault();

    //         try {
    //             const response = await fetch("https://map.kakao.com/link/search/${search}");

    //             if (response.ok){
    //                 const data = await response.json();
    //                 console.log('data = ' + data);
    //             } else {
    //                 throw new Error('error ' + response.status);
    //             }
    //         } catch (error){
    //             console.log('error = ' + error);
    //         }
    //     });
    // });

</script>
</body>
</html>
