<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>추천 게시판</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=***REMOVED***&autoload=false"></script>

</head>
<body>
<h1>추천 게시판</h1>

<!--검색하여 정렬-->
<input type="search" id="searchByStoreName">
<input type="button" id="searchButton" value="검색">
    <table border="1" id="recTable">
        <thead>
        <tr>
            <th>글 번호</th>
            <th>가게 이름</th>
            <th>추천 메뉴</th>
            <th>작성자</th>
            <th>작성일</th>
            <th>조회수</th>
            <th>좋아요</th>
            <th>싫어요</th>
        </tr>
        </thead>

        <tbody>
        <a id="detail">
            <tr th:each="board : ${list}">
                <!-- <td th:text="${board.recId}" th:value="${board.recId}" id="recId"></td> -->
                 <!-- td에는 value가 없다. 그래서 js에서 읽지 못하고 서버로 보내 null로 보내지는 오류가 있었다.
                  td는 value가 아니라 textContent 나 innerText로 읽어야 한다.
                  아니면 input 태그를 넣어 value로 읽는다-->
                <td><input type="text" th:value="${board.recId}" class="recId" readonly></td>
                <td th:text="${board.recStore}"></td>
                <td th:text="${board.recMenu}"></td>
                <td th:text="${board.memberId}"></td>
                <td th:text="${board.createDate}"></td>
                <td th:text="${board.recViews}"></td>
                <td><input type="button" class="recY"><span id="like"></span></td>
                <td><input type="button" class="recN"><span id="dislike"></span></td>
            <!-- 바 형태로 표현했으면 좋겠다. -->
             <!-- 선택한 글만 열려서 좋아요싫어요 개수 보이게 만들기(그때 개수 서버에서 구해서 전달) -->
            </tr>
        </a>
        </tbody>
    </table>
    <input type="hidden" th:value="${loginId}" id="loginId">
    <!-- th:text는 html 요소의 텍스트 내용을 설정. 따라서 value로 읽으려면 th:value로 해야 한다 -->
    <a href="/sjhealthy"><button>메인</button></a>
    <a href="/sjhealthy/recommend/write" id="writeButton"><button>추천글 작성</button></a>


    <div id="map"></div>

<script>
    document.addEventListener("DOMContentLoaded", ()=>{

        // 검색 정렬
        const searchButton = document.getElementById("searchButton");
        
        searchButton.addEventListener("click", async (e)=> {
            const search = document.getElementById("searchByStoreName").value;

            if (!search){
                e.preventDefault();
                alert("검색어를 입력하세요.");
                return false;
            }

            try {
                const url = "/sjhealthy/recommend/sort/" + encodeURIComponent(search); 
                // 한글(가게 이름)을 보내면 깨질 수 있어 인코딩 해서 보내고 디코딩 해서 읽기
                
                const response = await fetch(url);
                const data = await response.json(); // 응답을 json으로 변환

                // 검색 결과가 1개가 아닐 때(=> 엔티티 배열이 아닐 때) 배열로 바꿔 처리
                // 안 바꾸면 forEach에서 오류가 난다.
                const array = Array.isArray(data) ? data : [data];

                // 검색 결과를 출력
                const tableBody = document.getElementById("recTable").getElementsByTagName("tbody")[0]; 
                // 이 메서드는 HtmlCollection 을 반환해서 tbody가 여러개면 뒤에 [0], [1] 등 인덱스를 사용해 접근
                // tbody 하나면 안 써도 된다는데 안 쓰니까 tbody랑 제대로 연결 안 돼서 씀
                
                // 내용 비움
                tableBody.innerHTML = "";

                    array.forEach((item, index) => {
                        // 행 추가
                        const row = tableBody.insertRow();
    
                        // 열 추가
                        const cell1 = row.insertCell(0);
                        const cell2 = row.insertCell(1);
                        const cell3 = row.insertCell(2);
                        const cell4 = row.insertCell(3);
                        const cell5 = row.insertCell(4);
                        const cell6 = row.insertCell(5);
                        const cell7 = row.insertCell(6);
                        const cell8 = row.insertCell(7);
    
                        // 내용 추가
                        // cell1.value = item.recId; // td엔 value 없음
                        const input1 = document.createElement("input");
                        input1.className = "recId";
                        input1.value = item.recId;
                        input1.type = "text";
                        input1.readOnly = true;
                        cell1.appendChild(input1);
                        
                        cell2.textContent = item.recStore;
                        cell3.textContent = item.recMenu;
                        cell4.textContent = item.memberId;
                        cell5.textContent = item.createDate;
                        cell6.textContent = item.recViews;
    
                        const dataRecY = document.createElement("button");
                        dataRecY.className = "recY";
                        dataRecY.textContent = "좋아요";
                        dataRecY.onclick = (e) => chooseLikeButton(e, index); // 이렇게 함수의 참조를 넘겨줘야 한다. 이벤트가 발생할 때 함수 호출
                        // recY.onclick = chooseLikeButton(); 이렇게 하면 바로 실행되어 반환값을 넘겨주는 형태라 X
                        cell7.appendChild(dataRecY);
    
                        const dataRecN = document.createElement("button");
                        dataRecN.className = "recN";
                        dataRecN.textContent = "싫어요";
                        dataRecN.onclick = (e) => chooseDislikeButton(e, index);
                        cell8.appendChild(dataRecN);
                    });
            } catch (error) {
                console.log('에러 = ' + error);
            }
        });


        const writeButton = document.getElementById("writeButton");
        const loginId = document.getElementById("loginId").value;
        console.log('loginId = ' + loginId);

        // 글 작성은 회원 전용
        if (writeButton){
            writeButton.addEventListener("click", async (e)=> {

                if (!loginId){
                    // 값이 없을 때는 null 이 아니라 "" 빈 문자열이 보내진다.
                    // 따라서 서버에서 보낸 값을 text로 설정하고 value를 읽어와도 해당 속성 값이 없으니 null이 아니라 ""를 읽어오게 됨
                    // 서버에서 null을 보내도 렌더링 되는 과정에서 ""가 되기 때문에
                    // 자바스크립트 조건문에서 null과 비교하는 건 의미가 없다.
                    // !로 하면 null일 때랑 빈 문자열일 때 둘 다 false로 판단하니까 이렇게 하면 됨
                    e.preventDefault(); // defaultPrevented는 이벤트가 취소됐는지 확인하는 메서드로 다른 거다. 잘못 쓰지 않도록 하자
                    alert('글은 회원만 작성할 수 있습니다.');
                    return false;
                }
            });
        }

        // 좋아요 싫어요 버튼 연결
        // const recY = document.getElementById("recY").value;
        // 버튼이 1개가 아니라 글마다 존재하니까 querySelectorAll()을 이용해야 한다.
        const recY = document.querySelectorAll(".recY");
        recY.forEach((Y, index) => { // index는 Y가 recY에서 몇 번째 요소인지를 나타내는 인덱스
            Y.addEventListener("click", (e)=> chooselikeButton(e, index));
        });
        
        const recN = document.querySelectorAll(".recN");
        recN.forEach((N, index) => {
            // 싫어요 버튼 연결
            N.addEventListener("click", (e)=> chooseDislikeButton(e, index));
        });

        async function chooseLikeButton(e, index){
            console.log("좋아요 이벤트 리스너 연결 " + index);
            e.preventDefault();
            // 쿼리셀렉터로는 value를 가져올 수 있으나 All일 때는 이렇게 해서 가져와야 한다.
            const recIds = document.querySelectorAll(".recId");
            console.log("recIds = " + recIds);
            const recId = recIds[index].value; // 각 value를 가져옴

            // id당 1번 버튼 누르기 가능(좋아요/싫어요 중 택1)
            if (!loginId){
                e.preventDefault();
                alert('회원 전용 기능입니다.');
                return false;
            }

            try {
                const response = await fetch("/sjhealthy/recommend/like", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recId: recId,
                        action: "like"
                        // memberId: loginId 세션에서 꺼내 씀
                    })
                });
                const data = await response.json();
                alert(data.message);

                // 좋아요 싫어요 개수 출력(상세페이지에서 사용)
                // const like = document.getElementById("like");
                // like.textContent = data.likeCount;
                // dislike.textContent = data.dislikeCount;
            } catch (error){
                console.log('오류 발생: ', error);
            }
        };


        async function chooseDislikeButton(e, index){
            console.log("싫어요 이벤트 리스너 연결 " + index);
                e.preventDefault();
                const recIds = document.querySelectorAll(".recId");
                const recId = recIds[index].value;

                // id당 1번 버튼 누르기 가능(좋아요/싫어요 중 택1)
                if (!loginId){
                    e.preventDefault();
                    alert('회원 전용 기능입니다.');
                    return false;
                }

                try {
                const response = await fetch("/sjhealthy/recommend/dislike", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recId: recId,
                        action: "dislike"
                        // memberId: loginId 세션에서 꺼내 씀
                    })
                });
                const data = await response.json();
                alert(data.message);

                // 좋아요 싫어요 개수 출력 -> 이거는 상세페이지에 출력
                const like = document.getElementById("like");
                like.textContent = data.likeCount;
                dislike.textContent = data.dislikeCount;
            } catch (error){
                console.log('오류 발생: ', error);
            }

            };

    });
</script>


</body>
</html>
