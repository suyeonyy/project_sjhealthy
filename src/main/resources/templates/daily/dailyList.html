<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset='utf-8' />
    <title>ì¼ì§€</title>
    <style>
        /* ìº˜ë¦°ë” ìœ„ì˜ í•´ë” ìŠ¤íƒ€ì¼(ë‚ ì§œê°€ ìˆëŠ” ë¶€ë¶„) */
        .fc-header-toolbar {
          padding-top: 1em;
          padding-left: 1em;
          padding-right: 1em;
        }

        #calendar {
            height: 674px !important;
        }

        .btn {
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          border: none;
          font-size: 14px;
        }

        .btn_st1 {
          background-color: #4CAF50;
          color: white;
        }

        .fc-daygrid-day-number {
            color: black !important;
            text-decoration: auto !important;
            cursor: auto !important;
        }

        .fc-col-header-cell-cushion  {
            color: black !important;
            text-decoration: auto !important;
            cursor: auto !important;
        }
    </style>
    <!-- í—¤ë” css -->
    <link rel="stylesheet" href="/css/header.css">
    <!-- í—¤ë”, ë©”ì¸, í‘¸í„° ìœ„ì¹˜ ê³ ì • -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div th:replace="~{fragment/header :: main-head}"></div>

<main>
    <span style="background: #F9F7F6; border-left: 0.5em solid rgb(30,136,255); padding: 0.5em; font-weight: 600; font-size:15px;">ì¼ì§€ ëª©ë¡</span>

    <!-- calendar íƒœê·¸ -->
    <div id='calendar-container'>
        <div id='calendar'></div>
    </div>

    <input type="hidden" id="memberId" name="memberId" th:value="${loginId}">
</main>
<!-- jquery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- fullcalendar CDN -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>
<!-- fullcalendar ì–¸ì–´ CDN -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>

<script th:inline="javascript">
    var dailyList = [[${dailyList}]];

    var initialDate;
    var moodEmoticons = {
        "10": "ğŸ˜Š",  // ì˜ˆ: ìƒì€ ì›ƒëŠ” ì–¼êµ´
        "20": "ğŸ˜",  // ì¤‘ì€ ë¬´í‘œì •
        "30": "ğŸ˜¢"   // í•˜ëŠ” ìš°ëŠ” ì–¼êµ´
    };

    $(document).ready(function() {
        // URLSearchParamsë¥¼ ì‚¬ìš©í•˜ì—¬ URL íŒŒë¼ë¯¸í„° ì½ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        let initialyear = urlParams.get('year');
        let initialmonth = urlParams.get('month');

        // yearì™€ monthê°€ ì¡´ì¬í•˜ë©´ ì´ˆê¸° ë‚ ì§œë¥¼ êµ¬ì„±, ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
        if (initialyear && initialmonth) {
            initialDate = initialyear + '-' + initialmonth + '-01';
        } else {
            initialDate = new Date().toISOString().split('T')[0]; // yyyy-mm-dd
        }

        if(dailyList.length > 0){
            var events = [];
            for(var i = 0; i < dailyList.length; i++){
                var selected = dailyList[i];
                var dailyDate = selected.dailyDate;
                var dailyTitle = selected.dailyTitle;

                var dailyGoalSf = selected.dailyGoalSf;
                var emoticon = moodEmoticons[dailyGoalSf] || ""; // í•´ë‹¹ ê°’ì´ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ì‚¬ìš©

                //var dateString = dailyList[i] + ""; //numberíƒ€ì…ìœ¼ë¡œ ë°›ì•„ì ¸, stringíƒ€ì…ìœ¼ë¡œ ë³€ê²½í•˜ê¸° ìœ„í•´ ""ì¶”ê°€
                //console.log(typeof dateString);

                // ë¬¸ìì—´ì„ ì—°, ì›”, ì¼ë¡œ ë¶„ë¦¬
                var year = dailyDate.substring(0, 4);
                var month = dailyDate.substring(4, 6) - 1; // ì›”ì€ 0ë¶€í„° ì‹œì‘
                var day = dailyDate.substring(6, 8);

                // ìƒˆë¡œìš´ Date ê°ì²´ ìƒì„±
                var date = new Date(year, month, day);

                // ë‚ ì§œ í˜•ì‹ì„ ì¶œë ¥
                var  startDate = date.toString(); //Thu Dec 12 2024 00:00:00 GMT+0900 (í•œêµ­ í‘œì¤€ì‹œ) ì™€ ê°™ì€ ë‚ ì§œ ê°ì²´ë¡œ ë³€ê²½


                var finalTitle = dailyTitle + " _ " + emoticon;

                // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°(response)ë¥¼ ì´ë²¤íŠ¸ ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë°°ì—´ì— ì¶”ê°€
                var event = {
                    //title: dailyTitle,
                    title: finalTitle,
                    start: dailyDate
                };
                events.push(event);

                /*
                // ìœ„ì—ì„œ ìƒì„±ëœ FullCalendar ì¸ìŠ¤í„´ìŠ¤ì— ì´ë²¤íŠ¸ ì¶”ê°€
                calendar.addEvent({
                    title: "í…ŒìŠ¤íŠ¸",    // ì´ë²¤íŠ¸ ì œëª©
                    start: startDate,   // ì´ë²¤íŠ¸ ì‹œì‘ ì‹œê°„
                    allDay: true        // í•˜ë£¨ ì¢…ì¼ ì´ë²¤íŠ¸
                });
                */
           }
           initializeFullCalendar(events);
       }else{
            var events = [];
            initializeFullCalendar(events);
       }
    });


    function initializeFullCalendar(event1) {
        var calendarEl = $('#calendar')[0];

        //FullCalendar ìƒì„± (í•œ ë²ˆë§Œ ìƒì„±)
        var calendar = new FullCalendar.Calendar(calendarEl, {
            height: '700px', // calendar ë†’ì´ ì„¤ì •
            expandRows: true, // í™”ë©´ì— ë§ê²Œ ë†’ì´ ì¬ì„¤ì •
            slotMinTime: '08:00', // Day ìº˜ë¦°ë”ì—ì„œ ì‹œì‘ ì‹œê°„
            slotMaxTime: '20:00', // Day ìº˜ë¦°ë”ì—ì„œ ì¢…ë£Œ ì‹œê°„
            // í•´ë”ì— í‘œì‹œí•  íˆ´ë°”
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                //right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' //month, week, day, list
            },
            initialView: 'dayGridMonth', // ì´ˆê¸° ë¡œë“œ ë ë•Œ ë³´ì´ëŠ” ìº˜ë¦°ë” í™”ë©´(ê¸°ë³¸ ì„¤ì •: ë‹¬)
            //initialDate: '2021-07-15', // ì´ˆê¸° ë‚ ì§œ ì„¤ì • (ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œê°€ ë³´ì¸ë‹¤.)

            initialDate: initialDate,
            navLinks: true, // ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ Day ìº˜ë¦°ë”ë‚˜ Week ìº˜ë¦°ë”ë¡œ ë§í¬
            editable: true, // ìˆ˜ì • ê°€ëŠ¥?
            selectable: true, // ë‹¬ë ¥ ì¼ì ë“œë˜ê·¸ ì„¤ì •ê°€ëŠ¥
            nowIndicator: true, // í˜„ì¬ ì‹œê°„ ë§ˆí¬
            dayMaxEvents: true, // ì´ë²¤íŠ¸ê°€ ì˜¤ë²„ë˜ë©´ ë†’ì´ ì œí•œ (+ ëª‡ ê°œì‹ìœ¼ë¡œ í‘œí˜„)
            locale: 'ko', // í•œêµ­ì–´ ì„¤ì •
            events: event1, // ì´ˆê¸°í™” ì‹œ events ë°°ì—´ ì‚¬ìš©
            datesSet: function (info) {
                currentMonth = info.view.title;
                calendar.refetchEvents(); // FullCalendarì— ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
            },
            select: function(arg) { // ìº˜ë¦°ë”ì—ì„œ ë“œë˜ê·¸ë¡œ ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

                var memberId = $("#memberId").val();

                var selectedDate = arg.startStr;  // ì„ íƒëœ ë‚ ì§œ (yyyy-mm-dd í˜•ì‹)
                // í˜„ì¬ ë³´ì´ëŠ” ìº˜ë¦°ë”ì— ìˆëŠ” ëª¨ë“  ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                var events = calendar.getEvents();
                // ì„ íƒëœ ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” ì´ë²¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                var eventExists = events.some(function(event) {
                    return event.startStr === selectedDate; // ì´ë²¤íŠ¸ì˜ ì‹œì‘ ë‚ ì§œê°€ ì„ íƒëœ ë‚ ì§œì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                });

                var clickedDate = arg.startStr;  //'yyyy-mm-dd'
                var dailyDate = clickedDate.replaceAll("-", "");  //'yyyyMMdd' í˜•ì‹ìœ¼ë¡œ ë³€í™˜

                if(memberId != ""){
                    if(!eventExists){
                        //í´ë¦­í•œ ë‚ ì§œ
                        var dailyDate = arg.startStr;
                        dailyDate = dailyDate.replaceAll("-","");//ë‚ ì§œ yyyymmdd í˜•ì‹ìœ¼ë¡œ ë³€ê²½
                        window.location.href = '../daily/dailyWriteDetail?dailyDate=' + encodeURIComponent(dailyDate);
                    }else{ //ì´ë¯¸ ë“±ë¡ëœ ì¼ì§€ìˆìŒ
                        //alert("ì´ë¯¸ ë“±ë¡ëœ ì¼ì§€ê°€ ìˆìŠµë‹ˆë‹¤.");
                        window.location.href = '../daily/dailyRead?dailyDate=' + encodeURIComponent(dailyDate);
                    }
                }else{
                    alert("ê¸€ì€ íšŒì›ë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    return;
                }
            },
            eventClick : function(info){
                //console.log(info.event.start);
                var date = info.event.start;
                var year = date.getFullYear() + "";
                var month = (date.getMonth() + 1).toString().padStart(2, '0') + ""; // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1ì„ ë”í•´ì•¼ í•©ë‹ˆë‹¤.
                var day = date.getDate().toString().padStart(2, '0') + "";

                // ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì¶œë ¥
                var dailyDate = year + month + day;


                window.location.href = '../daily/dailyRead?dailyDate=' + encodeURIComponent(dailyDate);
            },
            datesSet: function (info) {
                // í˜„ì¬ ì›”ì„ ì–»ê³ , í•„ìš”í•œ ê²½ìš° ì¶”ê°€ ì‘ì—…ì„ ìˆ˜í–‰
                var currentData = info.view.title; //ex.í˜„ì¬ ì›”: 2025ë…„ 2ì›” <-ì´ë ‡ê²Œ console ì°í˜

                // "ë…„"ì„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë…„ê³¼ ì›” ì¶”ì¶œ
                var parts = currentData.split('ë…„');
                var year = parts[0].trim(); // ë…„
                var month = parts[1].replace('ì›”', '').trim(); // ì›”

                // padStartë¥¼ ì‚¬ìš©í•˜ì—¬ 2ìë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜ (ê¸¸ì´ê°€ 2ê°€ ë  ë•Œê¹Œì§€ '0'ì„ ì¶”ê°€)
                month = month.padStart(2, '0');

                $.ajax({
                   url : '../daily/dailyNewList',
                   type : 'post',
                   data: {
                        year: year,
                        month: month
                   },
                   dataType: 'json',  // ì‘ë‹µ ë°ì´í„° í˜•ì‹ì„ JSONìœ¼ë¡œ ì„¤ì •
                   success : function(response) {
                      //console.log("success");
                      var dailyList = response.dailyList; // dailyList ë°°ì—´ì„ ì¶”ì¶œ

                      var events = [];  // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë°°ì—´ì„ ì´ˆê¸°í™”
                      if(dailyList != null){
                            if(dailyList.length > 0){

                                for(var i = 0; i < dailyList.length; i++){
                                    var selected = dailyList[i];
                                    var dailyDate = selected.dailyDate;
                                    var dailyTitle = selected.dailyTitle;
                                    var dailyGoalSf = selected.dailyGoalSf;
                                    var emoticon = moodEmoticons[dailyGoalSf] || ""; // í•´ë‹¹ ê°’ì´ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ì‚¬ìš©

                                    //var dateString = dailyList[i] + ""; //numberíƒ€ì…ìœ¼ë¡œ ë°›ì•„ì ¸, stringíƒ€ì…ìœ¼ë¡œ ë³€ê²½í•˜ê¸° ìœ„í•´ ""ì¶”ê°€
                                    //console.log(typeof dateString);

                                    // ë¬¸ìì—´ì„ ì—°, ì›”, ì¼ë¡œ ë¶„ë¦¬
                                    var year = dailyDate.substring(0, 4);
                                    var month = dailyDate.substring(4, 6) - 1; // ì›”ì€ 0ë¶€í„° ì‹œì‘
                                    var day = dailyDate.substring(6, 8);

                                    // ìƒˆë¡œìš´ Date ê°ì²´ ìƒì„±
                                    var date = new Date(year, month, day);

                                    // ë‚ ì§œ í˜•ì‹ì„ ì¶œë ¥
                                    var  startDate = date.toString(); //Thu Dec 12 2024 00:00:00 GMT+0900 (í•œêµ­ í‘œì¤€ì‹œ) ì™€ ê°™ì€ ë‚ ì§œ ê°ì²´ë¡œ ë³€ê²½

                                     var finalTitle = dailyTitle + " _ " + emoticon;

                                    // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°(response)ë¥¼ ì´ë²¤íŠ¸ ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë°°ì—´ì— ì¶”ê°€
                                    var event = {
                                        //title: dailyTitle,
                                        title: finalTitle,
                                        start: dailyDate
                                    };
                                    events.push(event);
                               }

                                // ì´ì „ ì´ë²¤íŠ¸ë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œìš´ ì´ë²¤íŠ¸ë¡œ ì—…ë°ì´íŠ¸
                                calendar.removeAllEvents();
                                calendar.addEventSource(events);  // ìƒˆ ì´ë²¤íŠ¸ ë°°ì—´ì„ ì´ë²¤íŠ¸ ì†ŒìŠ¤ë¡œ ì¶”ê°€

                                calendar.refetchEvents(); // FullCalendarì— ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                          }else{
                                var events = [];
                                calendar.refetchEvents(); // FullCalendarì— ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                          }

                      }
                   }, error : function() {
                      //console.log("fail");
                   }
                });
            }
        });

        // ìº˜ë¦°ë” ë Œë”ë§
        calendar.render();
    }
</script>
<!--
<a href="/sjhealthy">
    <button class="btn btn_st1" style="float: right; background: rgb(12,100,230); color:white;">ë©”ì¸</button>
</a>
-->
<div th:replace="~{fragment/footer :: main-foot}"></div>
</body>
</html>
