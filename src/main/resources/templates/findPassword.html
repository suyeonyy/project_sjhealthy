<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>LoginForm</title>
    <!-- 헤더, 메인, 푸터 위치 고정 -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div th:replace="~{fragment/headerNoSession :: main-head}"></div>
<main>
    <h1>비밀번호 찾기</h1>
<div>
    <form action="../member/find-password" method="POST" th:if="${memberDTO == null}" id="findPasswordForm">
        아이디: <input type="text" id="memberId" name="memberId"><br>
        이메일: <input type="text" id="memberEmail" name="memberEmail"><br>
        <button id="sendMail" type="button">인증번호 전송</button><br>
        인증번호: <input type="text" name="verificationCode" placeholder="인증번호를 입력하세요." id="verificationCode"><br>
        <input type="submit" value="비밀번호 찾기" id="submit">
    </form>
</div>
<br>
<div>
    <a href="/sjhealthy/member/login"><button>로그인</button></a>
</div>
</main>
<!--경로: /api/mail/confirm/json-->
<script>
    document.addEventListener("DOMContentLoaded", ()=> {
        const sendCode = document.getElementById("sendMail");
        const submit = document.getElementById("submit");
        const findPasswordForm = document.getElementById("findPasswordForm");
        const check = /^(.*[a-zA-Z])(?=.*[.])[a-zA-Z\.]+$/;

        // 인증번호
        if (sendCode){
            sendCode.addEventListener("click", async (e)=> {
                e.preventDefault();
                const email = document.getElementById("memberEmail").value;
                const memberId = document.getElementById("memberId").value;
            try {
                // 유효성 검사
                if (!memberId){
                    alert("아이디를 입력해 주세요.");
                } else if (!email){
                    alert("이메일을 입력해 주세요.");
                } else if (!check.test(email)){
                    alert("이메일 형식을 확인해 주세요.");
                } else {
                    const response = await fetch("../api/mail/confirm/json", {
                        method: 'Post',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            memberId: memberId
                        })
                    });
                    if (response.ok){
                        alert('해당 이메일로 인증번호를 전송하였습니다.\n확인 부탁드립니다.');
                    } else {
                        alert('메일 전송에 실패하였습니다.');
                    } 
                }
            } catch (error){
                console.log('오류 발생: ', error);
            }
        });
        }
 
        // 제출 버튼
        
        submit.addEventListener("click", async (e) => {
            e.preventDefault();

            const verificationCode = document.getElementById("verificationCode").value;
            const memberId = document.getElementById("memberId").value;
            const memberEmail = document.getElementById("memberEmail").value;
            
            if (!verificationCode){
                alert("인증번호를 입력해 주세요.");
                return;
            }

            try {
                const response = await fetch("/sjhealthy/member/find-password/check", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        memberId: memberId,
                        code: verificationCode,
                        memberEmail: memberEmail
                    })
                });
                const data = await response.json();
                console.log(data);
                if (!response.ok){
                    alert(data.message);
                    window.location.href="/sjhealthy/member/login";
                } else {
                    alert(data.message);
                    window.location.href="/sjhealthy/member/set-new-password";
                }

            } catch (error){
                alert("시스템 오류로 실패하였습니다.");
                window.location.href="/sjhealthy/member/login";

            }
        });

    });
</script>

<div th:replace="~{fragment/footer :: main-foot}"></div>
</body>
</html>
